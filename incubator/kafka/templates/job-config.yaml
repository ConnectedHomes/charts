{{- if .Values.topics -}}
{{- $zk := include "zookeeper.url" . -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ template "kafka.fullname" . }}-config"
  labels:
    app: {{ template "kafka.fullname" . }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    heritage: "{{ .Release.Service }}"
    release: "{{ .Release.Name }}"
spec:
  backoffLimit: {{ .Values.configJob.backoffLimit }}
  template:
    metadata:
      labels:
        app: {{ template "kafka.fullname" . }}
        release: "{{ .Release.Name }}"
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: init-zookeeper
          image: {{ printf "%s:%s" .Values.image .Values.imageTag }}
          env:
            - name: ZOOKEEPER_ADDRESS
              value: {{ include "zookeeper.url" . | quote }}
            - name: ZOOKEEPER_PATH
              value: {{ printf "/%s" uuidv4 | quote }}
            - name: SLEEP_INTERVAL
              value: "5"
          command:
            - sh
            - -ec
            - |
              check_zookeeper() {
              zookeeper-shell $ZOOKEEPER_ADDRESS create $ZOOKEEPER_PATH null \
              > /dev/null 2>&1 && \
              zookeeper-shell $ZOOKEEPER_ADDRESS delete $ZOOKEEPER_PATH \
              > /dev/null 2>&1
              }
              until check_zookeeper
              do
              echo "Waiting for Zookeeper..."
              sleep $SLEEP_INTERVAL
              done
              echo "Zookeeper is ready!"
      containers:
        - name: {{ template "kafka.fullname" . }}-config
          image: "{{ .Values.image }}:{{ .Values.imageTag }}"
          env:
          - name: ZOOKEEPER_ADDRESS
            value: {{ include "zookeeper.url" . }}
          - name: SLEEP_INTERVAL
            value: "5"
          command:
          - bash
          - -ec
          - |
            cd /usr/bin
            broker_count() {
            zookeeper-shell $ZOOKEEPER_ADDRESS ls /brokers/ids 2> /dev/null | tail -1 | sed -e 's;[^0-9 ];;g' | wc -w
            }
            echo "Applying runtime configuration..."
            {{- $defaultReplicationFactor := index .Values.configurationOverrides "default.replication.factor" -}}
            {{- range $n, $topic := .Values.topics -}}
            {{- $currentReplicationFactor := default $defaultReplicationFactor $topic.replicationFactor }}
            echo Need at least {{ $currentReplicationFactor }} brokers for topic {{ $topic.name }}
            while (( $(broker_count) < "{{ $currentReplicationFactor }}" ))
            do
            echo "Waiting for more brokers..."
            sleep $SLEEP_INTERVAL
            done
            echo Brokers are ready!
            {{- if and $topic.partitions $currentReplicationFactor $topic.reassignPartitions }}
            cat << EOF > {{ $topic.name }}-increase-replication-factor.json
            {"version":1, "partitions":[
            {{- $partitions := (int $topic.partitions) }}
            {{- $replicas := (int $currentReplicationFactor) }}
            {{- range $i := until $partitions }}
            {"topic":"{{ $topic.name }}","partition":{{ $i }},"replicas":[{{- range $j := until $replicas }}{{ $j }}{{- if ne $j (sub $replicas 1) }},{{- end }}{{- end }}]}{{- if ne $i (sub $partitions 1) }},{{- end }}
            {{- end }}
            ]}
            EOF
            kafka-reassign-partitions --zookeeper $ZOOKEEPER_ADDRESS --reassignment-json-file {{ $topic.name }}-increase-replication-factor.json --execute
            kafka-reassign-partitions --zookeeper $ZOOKEEPER_ADDRESS --reassignment-json-file {{ $topic.name }}-increase-replication-factor.json --verify
            {{- else if and $topic.partitions $currentReplicationFactor }}
            kafka-topics --zookeeper $ZOOKEEPER_ADDRESS --create --if-not-exists --force --topic {{ $topic.name }} --partitions {{ $topic.partitions }} --replication-factor {{ $currentReplicationFactor }}
            {{- else if $topic.partitions }}
            kafka-topics --zookeeper $ZOOKEEPER_ADDRESS --alter --force --topic {{ $topic.name }} --partitions {{ $topic.partitions }} || true
            {{- end }}
            {{- if $topic.defaultConfig }}
            kafka-configs --zookeeper $ZOOKEEPER_ADDRESS --entity-type topics --entity-name {{ $topic.name }} --alter --force --delete-config {{ nospace $topic.defaultConfig }} || true
            {{- end }}
            {{- if $topic.config }}
            kafka-configs --zookeeper $ZOOKEEPER_ADDRESS --entity-type topics --entity-name {{ $topic.name }} --alter --force --add-config {{ nospace $topic.config }}
            {{- end }}
            kafka-configs --zookeeper $ZOOKEEPER_ADDRESS --entity-type topics --entity-name {{ $topic.name }} --describe
            {{- if $topic.acls }}
            {{- range $a, $acl := $topic.acls }}
            {{ if and $acl.user $acl.operations }}
            kafka-acls --authorizer-properties zookeeper.connect={{ $zk }} --force --add --allow-principal User:{{ $acl.user }}{{- range $operation := $acl.operations }} --operation {{ $operation }} {{- end }} --topic {{ $topic.name }} {{ $topic.extraParams }}
            {{- end -}}
            {{- end -}}
            {{- end -}}
            {{- end -}}
            {{- end -}}
